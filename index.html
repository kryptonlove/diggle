<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.6.0/dist/ethers.min.js"></script>
</head>
<body>
    <h1>Simple Game</h1>
    <button id="start-btn">Start Game</button>
    <div id="game-container"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Ваш код в game.js теперь будет выполняться только после того, как страница загружена
            let provider, signer, usdcContract;
            let userAddress = '';
            const usdcAddress = '0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca'; // Адрес контракта USDC в сети Base
            const myAddress = 'YOUR_WALLET_ADDRESS'; // Твой адрес кошелька

            async function setup() {
                // Создаем канвас
                const canvas = createCanvas(400, 400);
                canvas.parent('game-container');
                document.getElementById('game-container').style.display = 'none';

                // Слушаем кнопку старта игры
                document.getElementById('start-btn').addEventListener('click', startGame);

                // Подключаем MetaMask
                if (typeof window.ethereum !== 'undefined') {
                    console.log('MetaMask is available!');
                    provider = new ethers.providers.Web3Provider(window.ethereum); // Правильное подключение
                } else {
                    alert('Please install MetaMask');
                }

                // Инициализируем контракт USDC
                const usdcAbi = [
                    "function transfer(address recipient, uint amount) public returns (bool)"
                ];
                usdcContract = new ethers.Contract(usdcAddress, usdcAbi, provider);
            }

            async function startGame() {
                // Подключение MetaMask
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();  // Получаем signer после подключения
                    userAddress = await signer.getAddress();
                    console.log('Connected address:', userAddress);
                    gameStarted = true;
                    document.getElementById('game-container').style.display = 'block';
                    document.getElementById('start-btn').style.display = 'none';
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                }
            }

            async function handleGameOver() {
                // Показываем окно для покупки жизни
                if (lives <= 0) {
                    const buyButton = document.createElement('button');
                    buyButton.innerText = 'Buy 1 Life for 1 USDC';
                    buyButton.onclick = buyLife;
                    document.body.appendChild(buyButton);
                }
            }

            async function buyLife() {
                try {
                    const amount = ethers.parseUnits("1", 6); // 1 USDC (с учетом 6 десятичных знаков)
                    const tx = await usdcContract.transfer(myAddress, amount);
                    await tx.wait();
                    console.log('Payment successful');
                    lives = 1; // Возвращаем 1 жизнь игроку
                    document.body.removeChild(document.querySelector('button')); // Убираем кнопку после покупки
                } catch (error) {
                    console.error('Error making payment:', error);
                }
            }

            // Инициализируем p5.js
            new p5(setup);
        });
    </script>
</body>
</html>
